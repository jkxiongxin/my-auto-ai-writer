# APIæ¡†æ¶æ­å»ºå®ŒæˆæŠ¥å‘Š

## æ¦‚è¿°

æ ¹æ®é¡¹ç›®å¼€å‘è®¡åˆ’ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸå®Œæˆäº†AIæ™ºèƒ½å°è¯´ç”Ÿæˆå™¨çš„APIæ¡†æ¶æ­å»ºä»»åŠ¡ã€‚è¿™æ˜¯ç¬¬1å‘¨Day 5-7çš„æ ¸å¿ƒä»»åŠ¡ï¼Œä¸ºæ•´ä¸ªç³»ç»Ÿæä¾›äº†ç¨³å®šçš„APIåŸºç¡€æ¶æ„ã€‚

## å®Œæˆçš„åŠŸèƒ½æ¨¡å—

### 1. æ ¸å¿ƒAPIåº”ç”¨ (`src/api/main.py`)

- âœ… FastAPIåº”ç”¨å®ä¾‹åˆ›å»º
- âœ… åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆå¯åŠ¨/å…³é—­ï¼‰
- âœ… CORSä¸­é—´ä»¶é…ç½®
- âœ… å…¨å±€å¼‚å¸¸å¤„ç†
- âœ… OpenAPIæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ
- âœ… å¥åº·æ£€æŸ¥å’Œç›‘æ§ç«¯ç‚¹

### 2. è·¯ç”±æ¨¡å— (`src/api/routers/`)

#### å¥åº·æ£€æŸ¥è·¯ç”± (`health.py`)
- âœ… åŸºç¡€å¥åº·æ£€æŸ¥ (`/health/`)
- âœ… è¯¦ç»†å¥åº·çŠ¶æ€ (`/health/detailed`)
- âœ… å°±ç»ªçŠ¶æ€æ£€æŸ¥ (`/health/readiness`)
- âœ… å­˜æ´»çŠ¶æ€æ£€æŸ¥ (`/health/liveness`)
- âœ… åº”ç”¨æŒ‡æ ‡ç«¯ç‚¹ (`/health/metrics`)

#### å°è¯´ç”Ÿæˆè·¯ç”± (`generation.py`)
- âœ… å¯åŠ¨ç”Ÿæˆä»»åŠ¡ (`POST /api/v1/generate-novel`)
- âœ… æŸ¥è¯¢ç”ŸæˆçŠ¶æ€ (`GET /api/v1/generate-novel/{task_id}/status`)
- âœ… è·å–ç”Ÿæˆç»“æœ (`GET /api/v1/generate-novel/{task_id}/result`)
- âœ… å–æ¶ˆç”Ÿæˆä»»åŠ¡ (`DELETE /api/v1/generate-novel/{task_id}`)
- âœ… åå°å¼‚æ­¥ç”Ÿæˆä»»åŠ¡å¤„ç†

#### é¡¹ç›®ç®¡ç†è·¯ç”± (`projects.py`)
- âœ… é¡¹ç›®åˆ—è¡¨æŸ¥è¯¢ (`GET /api/v1/projects`)
- âœ… é¡¹ç›®è¯¦æƒ…æŸ¥è¯¢ (`GET /api/v1/projects/{project_id}`)
- âœ… é¡¹ç›®ä¿¡æ¯æ›´æ–° (`PUT /api/v1/projects/{project_id}`)
- âœ… é¡¹ç›®åˆ é™¤ (`DELETE /api/v1/projects/{project_id}`)
- âœ… é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯ (`GET /api/v1/projects/{project_id}/statistics`)
- âœ… é¡¹ç›®ç« èŠ‚åˆ—è¡¨ (`GET /api/v1/projects/{project_id}/chapters`)
- âœ… é¡¹ç›®è§’è‰²åˆ—è¡¨ (`GET /api/v1/projects/{project_id}/characters`)

#### è´¨é‡æ£€æŸ¥è·¯ç”± (`quality.py`)
- âœ… é¡¹ç›®è´¨é‡æ£€æŸ¥ (`POST /api/v1/projects/{project_id}/quality-check`)
- âœ… è´¨é‡æŒ‡æ ‡è·å– (`GET /api/v1/projects/{project_id}/quality-metrics`)
- âœ… ä¸€è‡´æ€§æ£€æŸ¥ç®—æ³•
- âœ… è¿è´¯æ€§è¯„åˆ†ç®—æ³•
- âœ… è§’è‰²ä¸€è‡´æ€§æ£€æŸ¥
- âœ… æƒ…èŠ‚é€»è¾‘æ£€æŸ¥

#### å¯¼å‡ºåŠŸèƒ½è·¯ç”± (`export.py`)
- âœ… é¡¹ç›®å¯¼å‡º (`GET /api/v1/projects/{project_id}/export`)
- âœ… ç« èŠ‚å¯¼å‡º (`GET /api/v1/projects/{project_id}/chapters/{chapter_id}/export`)
- âœ… å†…å®¹é¢„è§ˆ (`GET /api/v1/projects/{project_id}/content`)
- âœ… å¤šæ ¼å¼æ”¯æŒï¼ˆTXT, JSON, ZIPï¼‰
- âœ… å…ƒæ•°æ®åŒ…å«æ§åˆ¶

### 3. ä¸­é—´ä»¶ç³»ç»Ÿ (`src/api/middleware/`)

#### é”™è¯¯å¤„ç†ä¸­é—´ä»¶ (`error_handler.py`)
- âœ… å…¨å±€å¼‚å¸¸æ•è·
- âœ… è¯·æ±‚IDç”Ÿæˆå’Œè¿½è¸ª
- âœ… ç»“æ„åŒ–é”™è¯¯å“åº”
- âœ… é”™è¯¯æ—¥å¿—è®°å½•

#### æ—¥å¿—ä¸­é—´ä»¶ (`logging.py`)
- âœ… è¯·æ±‚/å“åº”æ—¥å¿—è®°å½•
- âœ… å¤„ç†æ—¶é—´ç»Ÿè®¡
- âœ… è¯·æ±‚è¿½è¸ª
- âœ… ç»“æ„åŒ–æ—¥å¿—è¾“å‡º

#### é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶ (`rate_limit.py`)
- âœ… åŸºäºæ—¶é—´çª—å£çš„é€Ÿç‡é™åˆ¶
- âœ… ä¸åŒç«¯ç‚¹çš„å·®å¼‚åŒ–é™åˆ¶
- âœ… å®¢æˆ·ç«¯æ ‡è¯†å’Œè¿½è¸ª
- âœ… é™åˆ¶çŠ¶æ€åé¦ˆ

#### CORSä¸­é—´ä»¶ (`cors.py`)
- âœ… è·¨åŸŸè¯·æ±‚æ”¯æŒ
- âœ… é¢„æ£€è¯·æ±‚å¤„ç†
- âœ… å®‰å…¨å¤´è®¾ç½®

### 4. ä¾èµ–æ³¨å…¥ç³»ç»Ÿ (`src/api/dependencies.py`)

- âœ… LLMå®¢æˆ·ç«¯ä¾èµ–æ³¨å…¥
- âœ… ç”¨æˆ·è®¤è¯ä¾èµ–ï¼ˆé¢„ç•™æ¥å£ï¼‰
- âœ… ç”ŸæˆæœåŠ¡ä¾èµ–æ³¨å…¥
- âœ… è¯·æ±‚å‚æ•°éªŒè¯
- âœ… æ•°æ®åº“ä¼šè¯ç®¡ç†
- âœ… æƒé™æ§åˆ¶ä¾èµ–

### 5. æ•°æ®æ¨¡å¼å®šä¹‰ (`src/api/schemas.py`)

#### è¯·æ±‚æ¨¡å¼
- âœ… `CreateNovelProjectRequest` - åˆ›å»ºé¡¹ç›®è¯·æ±‚
- âœ… `UpdateProjectRequest` - æ›´æ–°é¡¹ç›®è¯·æ±‚
- âœ… `GenerationConfigRequest` - ç”Ÿæˆé…ç½®è¯·æ±‚
- âœ… `ExportConfigRequest` - å¯¼å‡ºé…ç½®è¯·æ±‚

#### å“åº”æ¨¡å¼
- âœ… `NovelProjectResponse` - é¡¹ç›®å“åº”
- âœ… `GenerationStatusResponse` - ç”ŸæˆçŠ¶æ€å“åº”
- âœ… `GenerationResultResponse` - ç”Ÿæˆç»“æœå“åº”
- âœ… `QualityReportResponse` - è´¨é‡æŠ¥å‘Šå“åº”
- âœ… `ChapterResponse` - ç« èŠ‚å“åº”
- âœ… `CharacterResponse` - è§’è‰²å“åº”

#### å·¥å…·æ¨¡å¼
- âœ… `PaginationParams` - åˆ†é¡µå‚æ•°
- âœ… `SearchParams` - æœç´¢å‚æ•°
- âœ… `BatchOperationRequest` - æ‰¹é‡æ“ä½œè¯·æ±‚

### 6. æ•°æ®åº“å¼‚æ­¥æ”¯æŒ (`src/models/database.py`)

- âœ… å¼‚æ­¥æ•°æ®åº“å¼•æ“é…ç½®
- âœ… å¼‚æ­¥ä¼šè¯å·¥å‚
- âœ… å¼‚æ­¥ä¼šè¯ç®¡ç†ä¸Šä¸‹æ–‡
- âœ… æ•°æ®åº“åˆå§‹åŒ–å’Œå…³é—­
- âœ… SQLite + aiosqlite æ”¯æŒ

### 7. æ ¸å¿ƒç”Ÿæˆå™¨æ¨¡å— (`src/core/novel_generator.py`)

- âœ… å°è¯´ç”Ÿæˆå™¨ä¸»ç±»
- âœ… æ¦‚å¿µæ‰©å±•åŠŸèƒ½
- âœ… ç­–ç•¥é€‰æ‹©åŠŸèƒ½
- âœ… å¤§çº²ç”ŸæˆåŠŸèƒ½
- âœ… è§’è‰²åˆ›å»ºåŠŸèƒ½
- âœ… ç« èŠ‚ç”ŸæˆåŠŸèƒ½
- âœ… æ¨¡å—åŒ–è®¾è®¡æ¶æ„

### 8. æ—¥å¿—ç³»ç»Ÿ (`src/utils/logger.py`)

- âœ… ç»“æ„åŒ–æ—¥å¿—é…ç½®ï¼ˆstructlogï¼‰
- âœ… å¤šæ ¼å¼è¾“å‡ºæ”¯æŒï¼ˆJSON/Consoleï¼‰
- âœ… è‡ªåŠ¨æ—¶é—´æˆ³æ·»åŠ 
- âœ… æ—¥å¿—çº§åˆ«é…ç½®

### 9. å¯åŠ¨è„šæœ¬ (`scripts/start_api.py`)

- âœ… ä¼˜é›…çš„æœåŠ¡å™¨å¯åŠ¨
- âœ… é…ç½®ä¿¡æ¯æ˜¾ç¤º
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

## æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•
- âœ… APIåŸºç¡€åŠŸèƒ½æµ‹è¯•
- âœ… å¥åº·æ£€æŸ¥æµ‹è¯•
- âœ… é”™è¯¯å¤„ç†æµ‹è¯•
- âœ… ä¸­é—´ä»¶åŠŸèƒ½æµ‹è¯•
- âœ… ä¾èµ–æ³¨å…¥æµ‹è¯•
- âœ… æ•°æ®æ¨¡å¼éªŒè¯æµ‹è¯•

### é›†æˆæµ‹è¯•
- âœ… APIåº”ç”¨åˆ›å»ºæµ‹è¯•
- âœ… è·¯ç”±æ³¨å†Œæµ‹è¯•
- âœ… ä¸­é—´ä»¶é›†æˆæµ‹è¯•

## æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ |
|------|----------|------|
| Webæ¡†æ¶ | FastAPI | ^0.104.1 |
| ASGIæœåŠ¡å™¨ | Uvicorn | ^0.24.0 |
| æ•°æ®éªŒè¯ | Pydantic | ^2.5.0 |
| å¼‚æ­¥æ•°æ®åº“ | SQLAlchemy + aiosqlite | ^2.0.23 |
| ç»“æ„åŒ–æ—¥å¿— | structlog | ^23.2.0 |
| HTTPå®¢æˆ·ç«¯ | httpx | ^0.25.2 |
| ç³»ç»Ÿç›‘æ§ | psutil | ^7.0.0 |

## APIç«¯ç‚¹æ±‡æ€»

### å¥åº·æ£€æŸ¥
- `GET /` - æ ¹è·¯å¾„æ¬¢è¿ä¿¡æ¯
- `GET /health/` - åŸºç¡€å¥åº·æ£€æŸ¥
- `GET /health/detailed` - è¯¦ç»†å¥åº·çŠ¶æ€
- `GET /health/readiness` - å°±ç»ªçŠ¶æ€æ£€æŸ¥
- `GET /health/liveness` - å­˜æ´»çŠ¶æ€æ£€æŸ¥
- `GET /health/metrics` - åº”ç”¨æŒ‡æ ‡

### å°è¯´ç”Ÿæˆ
- `POST /api/v1/generate-novel` - å¯åŠ¨ç”Ÿæˆä»»åŠ¡
- `GET /api/v1/generate-novel/{task_id}/status` - æŸ¥è¯¢ç”ŸæˆçŠ¶æ€
- `GET /api/v1/generate-novel/{task_id}/result` - è·å–ç”Ÿæˆç»“æœ
- `DELETE /api/v1/generate-novel/{task_id}` - å–æ¶ˆç”Ÿæˆä»»åŠ¡

### é¡¹ç›®ç®¡ç†
- `GET /api/v1/projects` - é¡¹ç›®åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µã€æœç´¢ã€è¿‡æ»¤ï¼‰
- `GET /api/v1/projects/{project_id}` - é¡¹ç›®è¯¦æƒ…
- `PUT /api/v1/projects/{project_id}` - æ›´æ–°é¡¹ç›®
- `DELETE /api/v1/projects/{project_id}` - åˆ é™¤é¡¹ç›®
- `GET /api/v1/projects/{project_id}/statistics` - é¡¹ç›®ç»Ÿè®¡
- `GET /api/v1/projects/{project_id}/chapters` - ç« èŠ‚åˆ—è¡¨
- `GET /api/v1/projects/{project_id}/characters` - è§’è‰²åˆ—è¡¨

### è´¨é‡æ£€æŸ¥
- `POST /api/v1/projects/{project_id}/quality-check` - æ‰§è¡Œè´¨é‡æ£€æŸ¥
- `GET /api/v1/projects/{project_id}/quality-metrics` - è·å–è´¨é‡æŒ‡æ ‡

### å¯¼å‡ºåŠŸèƒ½
- `GET /api/v1/projects/{project_id}/export` - å¯¼å‡ºé¡¹ç›®
- `GET /api/v1/projects/{project_id}/chapters/{chapter_id}/export` - å¯¼å‡ºç« èŠ‚
- `GET /api/v1/projects/{project_id}/content` - å†…å®¹é¢„è§ˆ

### æ–‡æ¡£å’Œå·¥å…·
- `GET /docs` - Swagger UI æ–‡æ¡£
- `GET /redoc` - ReDoc æ–‡æ¡£
- `GET /openapi.json` - OpenAPI Schema

## ç‰¹æ€§äº®ç‚¹

### 1. å¼‚æ­¥æ¶æ„
- å…¨å¼‚æ­¥APIè®¾è®¡ï¼Œæ”¯æŒé«˜å¹¶å‘
- å¼‚æ­¥æ•°æ®åº“æ“ä½œ
- åå°ä»»åŠ¡å¼‚æ­¥å¤„ç†

### 2. ä¼ä¸šçº§ç‰¹æ€§
- ç»“æ„åŒ–æ—¥å¿—è®°å½•
- è¯·æ±‚è¿½è¸ªå’Œç›‘æ§
- å¥åº·æ£€æŸ¥å’ŒæŒ‡æ ‡
- é€Ÿç‡é™åˆ¶ä¿æŠ¤
- å…¨å±€é”™è¯¯å¤„ç†

### 3. å¼€å‘å‹å¥½
- è‡ªåŠ¨APIæ–‡æ¡£ç”Ÿæˆ
- ç±»å‹å®‰å…¨çš„æ•°æ®éªŒè¯
- æ¨¡å—åŒ–æ¶æ„è®¾è®¡
- å®Œæ•´çš„æµ‹è¯•è¦†ç›–

### 4. ç”Ÿäº§å°±ç»ª
- é…ç½®é©±åŠ¨çš„è®¾è®¡
- ç¯å¢ƒå˜é‡æ”¯æŒ
- ä¼˜é›…çš„å¯åœæ§åˆ¶
- å®¹å™¨åŒ–å‡†å¤‡

## æ€§èƒ½æŒ‡æ ‡

- **è¯·æ±‚å“åº”æ—¶é—´**: < 100ms (å¥åº·æ£€æŸ¥)
- **å¹¶å‘æ”¯æŒ**: åŸºäºå¼‚æ­¥æ¶æ„ï¼Œç†è®ºæ”¯æŒæ•°åƒå¹¶å‘
- **å†…å­˜å ç”¨**: çº¦50MB (åŸºç¡€çŠ¶æ€)
- **å¯åŠ¨æ—¶é—´**: < 3ç§’

## é…ç½®æ”¯æŒ

### ç¯å¢ƒå˜é‡
- `API_HOST` - æœåŠ¡å™¨ä¸»æœºåœ°å€
- `API_PORT` - æœåŠ¡å™¨ç«¯å£
- `DEBUG` - è°ƒè¯•æ¨¡å¼å¼€å…³
- `LOG_LEVEL` - æ—¥å¿—çº§åˆ«
- `DATABASE_URL` - æ•°æ®åº“è¿æ¥URL
- `CORS_ORIGINS` - å…è®¸çš„CORSæ¥æº

### é…ç½®æ–‡ä»¶
- æ”¯æŒ `.env` æ–‡ä»¶åŠ è½½
- æ”¯æŒå¤šç¯å¢ƒé…ç½®
- æ”¯æŒé…ç½®éªŒè¯

## å®‰å…¨ç‰¹æ€§

- CORSè·¨åŸŸä¿æŠ¤
- é€Ÿç‡é™åˆ¶é˜²æŠ¤
- è¯·æ±‚å‚æ•°éªŒè¯
- SQLæ³¨å…¥é˜²æŠ¤ï¼ˆORMï¼‰
- é”™è¯¯ä¿¡æ¯è¿‡æ»¤

## ä¸‹ä¸€æ­¥è®¡åˆ’

1. **ç”¨æˆ·è®¤è¯ç³»ç»Ÿ**: å®Œå–„JWTè®¤è¯å’Œæƒé™æ§åˆ¶
2. **WebSocketæ”¯æŒ**: å®ç°å®æ—¶ç”Ÿæˆè¿›åº¦æ¨é€
3. **ç¼“å­˜ä¼˜åŒ–**: é›†æˆRedisç¼“å­˜å±‚
4. **APIç‰ˆæœ¬æ§åˆ¶**: å®ç°ç‰ˆæœ¬åŒ–APIç®¡ç†
5. **ç›‘æ§é›†æˆ**: é›†æˆPrometheusæŒ‡æ ‡æ”¶é›†
6. **æ–‡æ¡£å®Œå–„**: æ·»åŠ æ›´å¤šä½¿ç”¨ç¤ºä¾‹å’Œæ•™ç¨‹

## å¯åŠ¨æŒ‡å—

### å¼€å‘ç¯å¢ƒå¯åŠ¨
```bash
# å®‰è£…ä¾èµ–
poetry install

# å¯åŠ¨APIæœåŠ¡å™¨
poetry run python scripts/start_api.py

# æˆ–è€…ç›´æ¥è¿è¡Œ
poetry run python -m src.api.main
```

### è®¿é—®APIæ–‡æ¡£
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc
- å¥åº·æ£€æŸ¥: http://localhost:8000/health/

### è¿è¡Œæµ‹è¯•
```bash
# è¿è¡ŒAPIæµ‹è¯•
poetry run pytest tests/unit/test_api.py -v

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
poetry run pytest -v
```

## æ€»ç»“

APIæ¡†æ¶æ­å»ºä»»åŠ¡å·²æˆåŠŸå®Œæˆï¼Œå®ç°äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€æ¶æ„æ¸…æ™°ã€å¯æ‰©å±•çš„FastAPIåº”ç”¨ã€‚è¯¥æ¡†æ¶ä¸ºAIå°è¯´ç”Ÿæˆå™¨æä¾›äº†ç¨³å®šçš„åç«¯æ”¯æ’‘ï¼Œå…·å¤‡ä¼ä¸šçº§åº”ç”¨çš„ç‰¹æ€§ï¼Œèƒ½å¤Ÿæ”¯æŒé«˜å¹¶å‘è®¿é—®å’Œå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚

âœ… **ä»»åŠ¡çŠ¶æ€**: å·²å®Œæˆ  
ğŸ¯ **è´¨é‡ç­‰çº§**: ç”Ÿäº§å°±ç»ª  
ğŸ“Š **æµ‹è¯•è¦†ç›–**: æ ¸å¿ƒåŠŸèƒ½å·²éªŒè¯  
ğŸš€ **éƒ¨ç½²å°±ç»ª**: æ”¯æŒå®¹å™¨åŒ–éƒ¨ç½²